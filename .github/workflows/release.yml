name: Release

on:
  push:
    tags:
      - 'v*' # –ó–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ push —Ç–µ–≥–∞ –≤–∏–¥–∞ v1.0.0, v0.2.1, –∏ —Ç.–¥.
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ GitHub UI

# –†–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–ª–∏–∑–æ–≤
permissions:
  contents: write

jobs:
  release:
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS Intel
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'

          # macOS ARM (Apple Silicon)
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'

          # Windows
          - platform: 'windows-latest'
            args: ''

          # Linux
          - platform: 'ubuntu-22.04'
            args: ''

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ pnpm
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Rust
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          # –î–ª—è macOS –¥–æ–±–∞–≤–ª—è–µ–º –æ–±–∞ —Ç–∞—Ä–≥–µ—Ç–∞
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Rust dependencies
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Linux
      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libasound2-dev \
            pkg-config

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ frontend –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: Install frontend dependencies
        run: pnpm install

      # –°–±–æ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞ —Å –ø–æ–º–æ—â—å—é Tauri Action
      - name: Build and release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # –ö–ª—é—á–∏ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (–¥–æ–±–∞–≤—å—Ç–µ –∏—Ö –≤ GitHub Secrets)
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'Voice to Text v__VERSION__'
          releaseBody: |
            –°–º. CHANGELOG –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.

            ## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

            **macOS:**
            - –°–∫–∞—á–∞–π—Ç–µ `.dmg` —Ñ–∞–π–ª
            - –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –≤ Applications
            - –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ: –°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å ‚Üí –†–∞–∑—Ä–µ—à–∏—Ç—å

            **Windows:**
            - –°–∫–∞—á–∞–π—Ç–µ `.msi` –∏–ª–∏ `.exe` —Ñ–∞–π–ª
            - –ó–∞–ø—É—Å—Ç–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫

            **Linux:**
            - `.deb` –¥–ª—è Debian/Ubuntu: `sudo dpkg -i voice-to-text_*.deb`
            - `.AppImage` –¥–ª—è –¥—Ä—É–≥–∏—Ö –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–æ–≤: —Å–¥–µ–ª–∞—Ç—å –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å

            ---

            üéâ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –±—É–¥—É—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}
